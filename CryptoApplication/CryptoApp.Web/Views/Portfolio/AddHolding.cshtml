@model CryptoApp.Domain.Models.Holding
@{
    ViewData["Title"] = "Add Cryptocurrency";
}

<h2>Add Cryptocurrency to Portfolio</h2>

<div class="row">
    <div class="col-md-12">
        @if (TempData["Error"] != null)
        {
            <div class="alert alert-danger">
                @TempData["Error"]
            </div>
        }

        <form asp-action="AddHolding" method="post" class="mb-4">
            <div asp-validation-summary="ModelOnly" class="text-danger"></div>
            <input type="hidden" asp-for="PortfolioId" />

            <div class="form-group mb-3">
                <label for="cryptoSearch" class="form-label">Search Cryptocurrency</label>
                <input type="text" id="cryptoSearch" class="form-control" placeholder="Type to search..." />
            </div>

            <div class="form-group mb-3">
                <label asp-for="CryptocurrencyId" class="form-label">Select Cryptocurrency</label>
                <select asp-for="CryptocurrencyId" class="form-select">
                    <option value="">-- Select a cryptocurrency --</option>
                    @foreach (var crypto in ViewBag.Cryptocurrencies)
                    {
                        <option value="@crypto.Id">@crypto.Symbol - @crypto.Name</option>
                    }
                </select>
                <span asp-validation-for="CryptocurrencyId" class="text-danger"></span>
            </div>

            <div class="form-group mb-3">
                <label asp-for="Quantity" class="form-label">Quantity</label>
                <input asp-for="Quantity" class="form-control" type="number" step="any" />
                <span asp-validation-for="Quantity" class="text-danger"></span>
            </div>

            <div class="form-group mb-3">
                <button type="submit" class="btn btn-primary">Add to Portfolio</button>
                <a asp-action="Details" asp-route-id="@Model.PortfolioId" class="btn btn-secondary">Back to Portfolio</a>
            </div>
        </form>

        <div class="mt-4">
            <nav aria-label="Cryptocurrency list navigation">
                <ul class="pagination">
                    @for (int i = 1; i <= ViewBag.TotalPages; i++)
                    {
                        <li class="page-item @(i == ViewBag.CurrentPage ? "active" : "")">
                            <a class="page-link" href="@Url.Action("AddHolding", new { id = Model.PortfolioId, page = i })">@i</a>
                        </li>
                    }
                </ul>
            </nav>
            <small class="text-muted">Showing @ViewBag.Cryptocurrencies.Count out of @ViewBag.TotalCount cryptocurrencies</small>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        $(document).ready(function() {
            let searchTimeout;
            
            $('#cryptoSearch').on('keyup', function() {
                clearTimeout(searchTimeout);
                const searchTerm = $(this).val();
                
                if (searchTerm.length < 2) return;
                
                searchTimeout = setTimeout(function() {
                    $.get('@Url.Action("SearchCryptos")', { term: searchTerm })
                        .done(function(data) {
                            const select = $('#CryptocurrencyId');
                            select.empty();
                            select.append($('<option>', {
                                value: '',
                                text: '-- Select a cryptocurrency --'
                            }));
                            
                            data.forEach(function(item) {
                                select.append($('<option>', {
                                    value: item.id,
                                    text: item.text
                                }));
                            });
                        });
                }, 300);
            });
        });
    </script>
}
